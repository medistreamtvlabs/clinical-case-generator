services:
  # PostgreSQL Database
  - type: pserv
    name: clinical-case-db
    plan: standard
    region: oregon
    ipAllowList: []
    databaseName: caso_clinico_db
    user: postgres
    postgresSQLVersion: "15"

  # Next.js Application
  - type: web
    name: clinical-case-generator
    plan: standard
    region: oregon
    runtime: node
    runtimeVersion: 18

    buildCommand: npm install --legacy-peer-deps --force && npx prisma generate && npm run build
    startCommand: npm start

    envVars:
      # Environment
      - key: NODE_ENV
        value: production

      # Database URL (reference to database service)
      - key: DATABASE_URL
        fromDatabase:
          name: clinical-case-db
          property: connectionString

      # Public App URL (will be set during deployment)
      - key: NEXT_PUBLIC_APP_URL
        fromService:
          type: web
          name: clinical-case-generator
          property: url

      # API Keys (set these in Render dashboard)
      - key: ANTHROPIC_API_KEY
        sync: false  # Must be set in dashboard

      # File Storage Configuration
      - key: UPLOAD_DIR
        value: /tmp/uploads

      - key: MAX_FILE_SIZE
        value: "10485760"

      # Feature Flags
      - key: ENABLE_ANALYTICS
        value: "false"

      - key: ENABLE_EXPORT
        value: "true"

      # Logging
      - key: LOG_LEVEL
        value: info

    # Deploy hooks
    preDeployCommand: npx prisma db push --skip-generate

    # Auto-deploy from GitHub
    repo: https://github.com/medistreamtvlabs/clinical-case-generator
    branch: main

    healthCheckPath: /
    numInstances: 1
    maxInstances: 1
